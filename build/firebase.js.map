{"version":3,"sources":["../src/firebase.js"],"names":["authenticate","admin","auth","getUser","process","env","USER_ID","then","userRecord","console","log","error","saveUserSearch","keyword","userId","db","database","ref","set","userRef","Promise","resolve","removeUserSearch","remove","getSearches","telegram","searchesRef","once","snapshot","values","val","Object","keys","forEach","key","keywords","results","users","chatId","promises","map","item","undefined","prices","reduce","previousValue","currentValue","Price","DisplayAmount","SavingBasis","Savings","sendPhoto","url","caption","parse_mode","all","errorObject","code","getListSearches","usersRef","listUserSearch","deleteSearch"],"mappings":"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","sourcesContent":["import { admin } from './firebaseConfig'\nimport { searchItems } from './amazonApi' \n\nexport function authenticate() {\n    admin\n    .auth()\n    .getUser(process.env.USER_ID)\n    .then((userRecord) => {\n        // See the UserRecord reference doc for the contents of userRecord.\n        console.log(`Successfully fetched user data`);\n    })\n    .catch((error) => {\n        console.log('Error fetching user data:', error);\n    });\n}\n\nexport function saveUserSearch(keyword, userId) {\n    const db = admin.database();\n    const ref = db.ref(`searches/${keyword}/${userId}`);\n    ref.set(1)\n\n    const userRef = db.ref(`users/${userId}/${keyword}`);\n    userRef.set(1)\n    return Promise.resolve(true)\n}\n\nexport function removeUserSearch(keyword, userId) {\n    const db = admin.database();\n    const ref = db.ref(`searches/${keyword}/${userId}`);\n    ref.remove()\n\n    const userRef = db.ref(`users/${userId}/${keyword}`);\n    userRef.remove()\n    return Promise.resolve(true)\n}\n\nexport function getSearches(telegram) {\n    console.log(\"getSearches\")\n    return new Promise(function (resolve) {\n        const searchesRef = admin.database().ref(\"searches\")\n\n        searchesRef.once(\"value\", async function(snapshot) {\n            const values = snapshot.val()\n            //console.log(values)\n            //console.log(Object.keys(values))\n            Object.keys(values).forEach(async function(key) {\n                const results = await searchItems({keywords: key})\n                console.log(\"keyword\", key)\n                const users = Object.keys(values[key])\n                console.log(users)\n                users.forEach(function(chatId) {\n                    console.log(\"chatId\", chatId)\n\n                    const promises = results.map(item => {\n                        if (\n                            item['Offers'] !== undefined &&\n                            item['Offers']['Listings'] !== undefined\n                        ) {\n                            \n                            const prices = item['Offers']['Listings'].reduce((previousValue, currentValue) => {\n                                previousValue = previousValue + `\n💶 <b>${currentValue.Price.DisplayAmount}</b> ${currentValue.SavingBasis ? `<strike> ${currentValue.SavingBasis.DisplayAmount} </strike>` : ''} ${currentValue.Price.Savings ? `Sconto di ${currentValue.Price.Savings.DisplayAmount}` : ''}\n                                `\n                                return previousValue;\n                            }, '');\n                        \n                \n                        return telegram.sendPhoto(chatId,\n                            { url: item['Images']['Primary']['Large']['URL'] },\n                            {\n                            caption: `<b>${item['ItemInfo']['Title']['DisplayValue']}</b>\n${prices}\n👉🏻 ${item['DetailPageURL']}`,\n                            parse_mode: 'HTML'\n                            }\n                        )\n                        }\n                    })\n                \n                    Promise.all(promises).then(() => {})\n                })\n            });\n        }, function (errorObject) {\n            console.log(\"The read failed: \" + errorObject.code);\n        });\n\n      resolve(true)\n    })\n}\n\n\nexport async function getListSearches() {\n    return new Promise(function (resolve) {\n        const usersRef = admin.database().ref(\"users\")\n        usersRef.once(\"value\", function(snapshot) {\n            const values = snapshot.val()\n\n            if (!values) return resolve([])\n\n            const users = Object.keys(values).map(function(key) {\n                const keys = Object.keys(values[key])\n                return {[key]: keys}\n            })\n            resolve(users)\n        })\n    });\n}\n\nexport async function listUserSearch(userId) {\n    return new Promise(function (resolve) {\n        const usersRef = admin.database().ref(`users/${userId}`)\n        usersRef.once(\"value\", function(snapshot) {\n            const values = snapshot.val()\n            if (!values) return resolve([])\n            const keys = Object.keys(values)\n            resolve(keys)\n        })\n    });\n}\n\nexport async function deleteSearch() {\n    return new Promise(function (resolve) {\n        resolve(true)\n    })\n}"],"file":"firebase.js"}